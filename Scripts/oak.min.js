var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var Parameter;(function(Parameter){Parameter[Parameter["immediate"]=0]="immediate";Parameter[Parameter["register"]=1]="register";Parameter[Parameter["condition"]=2]="condition";Parameter[Parameter["offset"]=3]="offset";Parameter[Parameter["special"]=4]="special";Parameter[Parameter["fpImmediate"]=5]="fpImmediate"})(Parameter||(Parameter={}));var Endianness;(function(Endianness){Endianness[Endianness["little"]=0]="little";Endianness[Endianness["big"]=1]="big";Endianness[Endianness["bi"]=2]="bi"})(Endianness||(Endianness={}));var Keyword;(function(Keyword){Keyword[Keyword["directive"]=0]="directive";Keyword[Keyword["comment"]=1]="comment";Keyword[Keyword["label"]=2]="label";Keyword[Keyword["stringMarker"]=3]="stringMarker";Keyword[Keyword["charMarker"]=4]="charMarker";Keyword[Keyword["register"]=5]="register";Keyword[Keyword["string"]=6]="string";Keyword[Keyword["char"]=7]="char";Keyword[Keyword["numeric"]=8]="numeric"})(Keyword||(Keyword={}));var Directive;(function(Directive){Directive[Directive["text"]=0]="text";Directive[Directive["data"]=1]="data";Directive[Directive["string"]=2]="string";Directive[Directive["cString"]=3]="cString";Directive[Directive["_8bit"]=4]="_8bit";Directive[Directive["_16bit"]=5]="_16bit";Directive[Directive["_32bit"]=6]="_32bit";Directive[Directive["_64bit"]=7]="_64bit";Directive[Directive["fixedPoint"]=8]="fixedPoint";Directive[Directive["floatingPoint"]=9]="floatingPoint";Directive[Directive["custom"]=10]="custom"})(Directive||(Directive={}));var BitRange=function(){function BitRange(field,start,bits,constant,signed){if(constant===void 0){constant=null}if(signed===void 0){signed=false}this.field=field;this.start=start;this.bits=bits;this.constant=constant;this.signed=signed}BitRange.prototype.limited=function(totalBits,limitStart,limitEnd){if(limitStart===void 0){limitStart=null}if(limitEnd===void 0){limitEnd=null}this.totalBits=totalBits;this.limitStart=limitStart;this.limitEnd=limitEnd;return this};BitRange.prototype.parameterized=function(parameter,parameterType,parameterDefaultValue){if(parameterDefaultValue===void 0){parameterDefaultValue=null}this.parameter=parameter;this.parameterDefaultValue=parameterDefaultValue;this.parameterType=parameterType;return this};return BitRange}();var Format=function(){function Format(ranges,regex,disassembly,processSpecialParameter,decodeSpecialParameter){if(processSpecialParameter===void 0){processSpecialParameter=null}if(decodeSpecialParameter===void 0){decodeSpecialParameter=null}this.ranges=ranges;this.regex=regex;this.disassembly=disassembly;this.processSpecialParameter=processSpecialParameter;this.decodeSpecialParameter=decodeSpecialParameter}return Format}();var Instruction=function(){function Instruction(mnemonic,format,constants,constValues,executor,signatoryOverride){if(signatoryOverride===void 0){signatoryOverride=null}this.mnemonic=mnemonic;this.format=format;this.constants=[];for(var constant in constants){this.constants[constants[constant]]=constValues[constant]}this.executor=executor;this.signatoryOverride=signatoryOverride}Instruction.prototype.pad=function(str,length){var padded=str;for(var i=0;i<length-str.length;i++){padded="0"+padded}return padded};Instruction.prototype.mask=function(){var str="";for(var i=0;i<this.format.ranges.length;i++){var constant=this.constants[this.format.ranges[i].field];if(constant!==undefined){str+=this.pad(constant.toString(2),this.format.ranges[i].bits)}else if(this.format.ranges[i].constant!=null){str+=this.pad(this.format.ranges[i].constant.toString(2),this.format.ranges[i].bits)}else{for(var j=0;j<this.format.ranges[i].bits;j++){str+="X"}}}return str};Instruction.prototype.match=function(machineCode){var machineCodeMutable=machineCode>>>0;var maskBits=this.mask().split("");for(var i=31;i>=0;i--){if(maskBits[i]==="X"){machineCodeMutable=machineCodeMutable>>>1;continue}if(parseInt(maskBits[i])!==(machineCodeMutable&1)){return false}machineCodeMutable=machineCodeMutable>>>1}return true};Instruction.prototype.template=function(){var temp=0>>>0;for(var i=0;i<this.format.ranges.length;i++){var constant=this.constants[this.format.ranges[i].field];if(constant!==undefined){temp|=constant<<this.format.ranges[i].start}}return temp};return Instruction}();var PseudoInstruction=function(){function PseudoInstruction(){}return PseudoInstruction}();var InstructionSet=function(){function InstructionSet(name,bits,formats,instructions,pseudoInstructions,dataDirectives,dataDirectiveSizes,abiNames,process,tokenize,assemble,keywords,directives){this.name=name;this.bits=bits;this.formats=formats;this.instructions=instructions;this.pseudoInstructions=pseudoInstructions;this.dataDirectives=dataDirectives;this.dataDirectiveSizes=dataDirectiveSizes;this.abiNames=abiNames;this.keywords=keywords;this.directives=directives}InstructionSet.prototype.pseudoMnemonicSearch=function(mnemonic){return-1};InstructionSet.prototype.mnemonicSearch=function(mnemonic){for(var i=0;i<this.instructions.length;i++){if(this.instructions[i].mnemonic==mnemonic){return i}}return-1};InstructionSet.prototype.instructionPrefixing=function(line){for(var i in this.instructions){var instruction=this.instructions[i];if(line.toUpperCase().hasPrefix(instruction.mnemonic)){var captures=instruction.format.regex.exec(line);if(captures&&captures[1].toUpperCase()==instruction.mnemonic){return instruction}}}return null};InstructionSet.prototype.disassemble=function(instruction,args){var output=instruction.format.disassembly;output=output.replace("@mnem",instruction.mnemonic);for(var i=0;i<instruction.format.ranges.length;i++){var range=instruction.format.ranges[i];if(range.parameter!=null){output=output.replace("@arg"+range.parameter,range.parameterType===Parameter.register?this.abiNames[args[i]]:args[i].toString())}}return output};return InstructionSet}();var Core=function(){function Core(){}Core.prototype.memcpy=function(address,bytes){if(address+bytes>this.memorySize){return null}var result=[];for(var i=0;i<bytes;i++){result.push(this.memory[address+i])}return result};Core.prototype.memset=function(address,bytes){if(address<0){return false}if(address+bytes.length>this.memorySize){return false}for(var i=0;i<bytes.length;i++){this.memory[address+i]=bytes[i]}return true};Core.prototype.decode=function(){var insts=this.instructionSet.instructions;this.decoded=null;this.arguments=[];for(var i=0;i<insts.length;i++){if(insts[i].match(this.fetched)){this.decoded=insts[i];break}}if(this.decoded==null){return null}var bitRanges=this.decoded.format.ranges;for(var i=0;i<bitRanges.length;i++){if(bitRanges[i].parameter!=null){var limit=bitRanges[i].limitStart;var field=bitRanges[i].field;var bits=bitRanges[i].bits;var value=(this.fetched>>>bitRanges[i].start&(1<<bitRanges[i].bits)-1)<<limit;if(bitRanges[i].parameterType===Parameter.special){value=this.decoded.format.decodeSpecialParameter(value,this.pc)}this.arguments[bitRanges[i].parameter]=this.arguments[bitRanges[i].parameter]|value;if(this.decoded.format.ranges[i].signed&&bitRanges[i].parameterType!==Parameter.register){this.arguments[bitRanges[i].parameter]=signExt(this.arguments[i],bitRanges[i].totalBits?bitRanges[i].totalBits:bitRanges[i].bits)}}}return this.instructionSet.disassemble(this.decoded,this.arguments)};Core.prototype.execute=function(){return this.decoded.executor(this)};return Core}();function rangeCheck(value,bits){if(bits==32){return true}if(bits>32){return false}var min=-(1<<bits-1);var max=(1<<bits-1)-1;value=signExt(value,bits);if(value>>0<=max&&value>>0>=min){return true}return false}function signExt(value,bits){var mutableValue=value;if((mutableValue&1<<bits-1)!==0){mutableValue=~0>>>bits<<bits|value}return mutableValue}function catBytes(bytes){if(bytes.length>4){return null}var storage=0>>>0;for(var i=0;i<bytes.length;i++){storage=storage|bytes[i]<<8*i}return storage}String.prototype.interpretedBytes=function(){var hexes=this.split(" ");var bytes=[];for(var i=0;i<hexes.length;i++){var value=parseInt(hexes[i],16);if(!isNaN(value)){bytes.push(value)}}return bytes};Array.prototype.hexed=function(){var hexadecimal="";for(var i=0;i<this.length;i++){var hexRepresentation=this[i].toString(16).toUpperCase();if(hexRepresentation.length===1){hexRepresentation="0"+hexRepresentation}hexadecimal+=hexRepresentation+" "}return hexadecimal};function unwrap(optional,unwrapBehavior){if(optional!==null&&optional!==undefined){unwrapBehavior(optional);return true}else{return false}}String.prototype.hasPrefix=function(needle){return this.substr(0,needle.length)===needle};var Assembler=function(){function Assembler(instructionSet,endianness,memoryMap){if(memoryMap===void 0){memoryMap=null}this.incrementOnFetch=instructionSet.incrementOnFetch;this.keywordRegexes=[];this.memoryMap=memoryMap;if(instructionSet.keywordRegexes){this.keywordRegexes=instructionSet.keywordRegexes}else if(instructionSet.keywords){var words=instructionSet.keywords;this.keywordRegexes=new Array;if(words[Keyword.directive]){var options=Assembler.options(instructionSet.keywords[Keyword.directive]);if(options){this.keywordRegexes[Keyword.directive]=options+"([^\\s]+)\\s*(.+)*"}}if(words[Keyword.stringMarker]){var options=Assembler.options(words[Keyword.stringMarker]);if(options){this.keywordRegexes[Keyword.string]=options+"(.*?)"+options}}if(words[Keyword.comment]){var options=Assembler.options(words[Keyword.comment]);if(options){this.keywordRegexes[Keyword.comment]="(.*?)("+options+".*)"}}if(words[Keyword.label]){var options=Assembler.options(words[Keyword.label]);if(options){this.keywordRegexes[Keyword.label]="(([A-Za-z_][A-Za-z0-9_]*)"+options+")?\\s*(.*)?"}}if(words[Keyword.register]){var options=Assembler.options(words[Keyword.register]);if(options){this.keywordRegexes[Keyword.register]=options+"([0-9]+)"}}this.keywordRegexes[Keyword.numeric]="(?:0(["+Assembler.radixList+"]))?([A-F0-9]+)";if(words[Keyword.charMarker]){var options=Assembler.options(words[Keyword.charMarker]);if(options){var escapable=options.length>1?"":"\\"+options;this.keywordRegexes[Keyword.char]=options+"((?:.)|(\\\\[\\\\"+Assembler.escapedCharacterList+escapable+"]))"+options}}}else{console.log('Instruction Set Warning: This instruction set doesn\'t define any keywords.\nTo suppress this warning, pass an empty [:] to "keywords"')}this.directives=instructionSet.directives;this.endianness=endianness?endianness:instructionSet.endianness;this.instructionSet=instructionSet}Assembler.prototype.process=function(text,address,instructionLength,type,bits,labels){var array=text.split("");var result={errorMessage:null,value:null};switch(type){case Parameter.register:var index=this.instructionSet.abiNames.indexOf(text);if(index!==-1){result.value=index;return result}var registerNo=null;if(this.keywordRegexes[Keyword.register]){registerNo=new RegExp(this.keywordRegexes[Parameter.register]).exec(text)[1]}else{result.errorMessage="Register "+text+" does not exist.";return result}registerNo=parseInt(registerNo);if((registerNo&~0<<bits)!==0){result.errorMessage="Register "+text+" does not exist.";return result}result.value=registerNo;return result;case Parameter.offset:case Parameter.immediate:var value=labels[text];if(value===undefined&&this.keywordRegexes[Keyword.char]){var extraction=RegExp(this.keywordRegexes[Keyword.char]).exec(text);if(extraction!==null&&extraction[1]!==undefined){value=extraction[1].charCodeAt(0);if(value>255){result.errorMessage="Non-ascii character "+extraction[1]+" unsupported.";return result}}}if(type!=Parameter.offset&&value===undefined&&this.keywordRegexes[Keyword.numeric]!==undefined){var array_1=RegExp(this.keywordRegexes[Keyword.numeric]).exec(text);var radix=Assembler.radixes[array_1[1]];var interpretable=array_1[2];value=parseInt(interpretable,radix)}if(type==Parameter.offset){value=value-(address+(this.incrementOnFetch?instructionLength:0))}if(isNaN(value)){result.errorMessage="Immediate '"+text+"' is not a recognized label, literal or character.";return result}else if(!rangeCheck(value,bits)){result.errorMessage="The value of '"+value+"' is out of range.";return result}result.value=value;return result;default:result.errorMessage="Oak Error: Parameter type unsupported.";return result}};Assembler.options=function(list){if(list.length==0){return null}var options="";for(var i=0;i<list.length;i++){var keyword=list[i];if(keyword=="\\"){console.log("Instruction Set Error: Escape character \\ cannot be used as a keyword.")}if(options==""){options="(?:"}else{options+="|"}options+=keyword}return options+")"};Assembler.radixes={b:2,o:8,d:10,h:16};Assembler.radixList=Object.keys(Assembler.radixes).join("");Assembler.escapedCharacters={0:0,t:9,n:10,r:13};Assembler.escapedCharacterList=Object.keys(Assembler.escapedCharacters).join("");return Assembler}();function Oak_gen_RISCV(){var formats=[];var instructions=[];var pseudoInstructions=[];formats.push(new Format([new BitRange("funct7",25,7),new BitRange("rs2",20,5).parameterized(2,Parameter.register),new BitRange("rs1",15,5).parameterized(1,Parameter.register),new BitRange("funct3",12,3),new BitRange("rd",7,5).parameterized(0,Parameter.register),new BitRange("opcode",0,7)],/[a-zA-Z]+\s*([A-Za-z0-9]+)\s*,\s*([A-Za-z0-9]+)\s*,\s*([A-Za-z0-9]+)/,"@mnem @arg0, @arg1, @arg2"));var rType=formats[formats.length-1];instructions.push(new Instruction("ADD",rType,["opcode","funct3","funct7"],[51,0,0],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])+core.registerFile.read(core.arguments[2]));core.pc+=4;return null}));instructions.push(new Instruction("SUB",rType,["opcode","funct3","funct7"],[51,0,32],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])-core.registerFile.read(core.arguments[2]));core.pc+=4;return null}));instructions.push(new Instruction("SLL",rType,["opcode","funct3","funct7"],[51,1,0],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])<<core.registerFile.read(core.arguments[2]));core.pc+=4;return null}));instructions.push(new Instruction("SLT",rType,["opcode","funct3","funct7"],[51,2,0],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])<core.registerFile.read(core.arguments[2])?1:0);core.pc+=4;return null}));instructions.push(new Instruction("SLTU",rType,["opcode","funct3","funct7"],[51,3,0],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>>0<core.registerFile.read(core.arguments[2])>>>0?1:0);core.pc+=4;return null}));instructions.push(new Instruction("XOR",rType,["opcode","funct3","funct7"],[51,4,0],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])^core.registerFile.read(core.arguments[2]));core.pc+=4;return null}));instructions.push(new Instruction("SRL",rType,["opcode","funct3","funct7"],[51,5,0],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>>core.registerFile.read(core.arguments[2]));core.pc+=4;return null}));instructions.push(new Instruction("SRA",rType,["opcode","funct3","funct7"],[51,5,32],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>core.registerFile.read(core.arguments[2]));core.pc+=4;return null}));instructions.push(new Instruction("OR",rType,["opcode","funct3","funct7"],[51,6,0],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])|core.registerFile.read(core.arguments[2]));core.pc+=4;return null}));instructions.push(new Instruction("AND",rType,["opcode","funct3","funct7"],[51,7,0],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])&core.registerFile.read(core.arguments[2]));core.pc+=4;return null}));formats.push(new Format([new BitRange("imm",20,12,null,true).parameterized(2,Parameter.immediate),new BitRange("rs1",15,5).parameterized(1,Parameter.register),new BitRange("funct3",12,3),new BitRange("rd",7,5).parameterized(0,Parameter.register),new BitRange("opcode",0,7)],/[a-zA-Z]+\s*([A-Za-z0-9]+)\s*,\s*([A-Za-z0-9]+),\s*(-?[a-zA-Z0-9_]+)/,"@mnem @arg0, @arg1, @arg2"));var iType=formats[formats.length-1];instructions.push(new Instruction("JALR",iType,["opcode","funct3"],[103,0],function(core){core.registerFile.write(core.arguments[0],core.pc);core.pc=core.registerFile.read(core.arguments[1])+signExt(core.arguments[2],12);return null}));instructions.push(new Instruction("ADDI",iType,["opcode","funct3"],[19,0],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])+core.arguments[2]);core.pc+=4;return null}));instructions.push(new Instruction("SLTI",iType,["opcode","funct3"],[19,2],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])<core.arguments[2]?1:0);core.pc+=4;return null}));instructions.push(new Instruction("SLTIU",iType,["opcode","funct3"],[19,3],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>>0<core.arguments[2]>>>0?1:0);core.pc+=4;return null},false));instructions.push(new Instruction("XORI",iType,["opcode","funct3"],[19,4],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>>0^core.arguments[2]);core.pc+=4;return null}));instructions.push(new Instruction("ORI",iType,["opcode","funct3"],[19,6],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>>0|core.arguments[2]);core.pc+=4;return null}));instructions.push(new Instruction("ANDI",iType,["opcode","funct3"],[19,7],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>>0&core.arguments[2]);core.pc+=4;return null}));formats.push(new Format([new BitRange("imm",20,12,null,true).parameterized(1,Parameter.immediate),new BitRange("rs1",15,5).parameterized(2,Parameter.register),new BitRange("funct3",12,3),new BitRange("rd",7,5).parameterized(0,Parameter.register),new BitRange("opcode",0,7)],/[a-zA-Z]+\s*([A-Za-z0-9]+)\s*,\s*(-?0?[boxd]?[0-9A-F]+)\s*\(\s*([A-Za-z0-9]+)\s*\)/,"@mnem @arg0, @arg2(@arg1)"));var ilSubtype=formats[formats.length-1];instructions.push(new Instruction("LB",ilSubtype,["opcode","funct3"],[3,0],function(core){var bytes=core.memcpy(core.registerFile.read(core.arguments[2])+core.arguments[1],1);if(bytes===null){return"Illegal memory access."}core.registerFile.write(core.arguments[0],signExt(bytes[0],8));core.pc+=4;return null}));instructions.push(new Instruction("LH",ilSubtype,["opcode","funct3"],[3,1],function(core){var bytes=core.memcpy(core.registerFile.read(core.arguments[2])+core.arguments[1],2);if(bytes===null){return"Illegal memory access."}core.registerFile.write(core.arguments[0],signExt(catBytes(bytes),16));core.pc+=4;return null}));instructions.push(new Instruction("LW",ilSubtype,["opcode","funct3"],[3,2],function(core){var bytes=core.memcpy(core.registerFile.read(core.arguments[2])+core.arguments[1],4);if(bytes===null){return"Illegal memory access."}core.registerFile.write(core.arguments[0],catBytes(bytes));core.pc+=4;return null}));instructions.push(new Instruction("LBU",ilSubtype,["opcode","funct3"],[3,4],function(core){var bytes=core.memcpy(core.registerFile.read(core.arguments[2])+core.arguments[1],1);if(bytes===null){return"Illegal memory access."}core.registerFile.write(core.arguments[0],bytes[0]);core.pc+=4;return null}));instructions.push(new Instruction("LHU",ilSubtype,["opcode","funct3"],[3,5],function(core){var bytes=core.memcpy(core.registerFile.read(core.arguments[2])+core.arguments[1],2);if(bytes===null){return"Illegal memory access."}core.registerFile.write(core.arguments[0],catBytes(bytes));core.pc+=4;return null}));formats.push(new Format([new BitRange("funct7",25,7),new BitRange("shamt",20,5).parameterized(2,Parameter.immediate),new BitRange("rs1",15,5).parameterized(1,Parameter.register),new BitRange("funct3",12,3),new BitRange("rd",7,5).parameterized(0,Parameter.register),new BitRange("opcode",0,7)],/[a-zA-Z]+\s*([A-Za-z0-9]+)\s*,\s*([A-Za-z0-9]+),\s*(-?0?[boxd]?[0-9A-F]+)/,"@mnem @arg0, @arg1, @arg2"));var isSubtype=formats[formats.length-1];instructions.push(new Instruction("SLLI",isSubtype,["opcode","funct3","funct7"],[19,1,0],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])<<core.arguments[2]);core.pc+=4;return null}));instructions.push(new Instruction("SRLI",isSubtype,["opcode","funct3","funct7"],[19,5,0],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>>core.arguments[2]);core.pc+=4;return null}));instructions.push(new Instruction("SRAI",isSubtype,["opcode","funct3","funct7"],[19,5,32],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>core.arguments[2]);core.pc+=4;return null}));formats.push(new Format([new BitRange("imm",25,7,null,true).parameterized(1,Parameter.immediate).limited(12,5,11),new BitRange("rs2",20,5).parameterized(0,Parameter.register),new BitRange("rs1",15,5).parameterized(2,Parameter.register),new BitRange("funct3",12,3),new BitRange("imm",7,5,null,true).parameterized(1,Parameter.immediate).limited(12,0,4),new BitRange("opcode",0,7)],/[a-zA-Z]+\s*([A-Za-z0-9]+)\s*,\s*(-?0?[boxd]?[0-9A-F]+)\(\s*([A-Za-z0-9]+)\s*\)/,"@mnem @arg0, @arg2(@arg1)"));var sType=formats[formats.length-1];instructions.push(new Instruction("SB",sType,["opcode","funct3"],[35,0],function(core){var bytes=[];bytes.push(core.registerFile.read(core.arguments[0])&255);if(core.memset(core.registerFile.read(core.arguments[2])+core.arguments[1],bytes)){core.pc+=4;return null}return"Illegal memory access."}));instructions.push(new Instruction("SH",sType,["opcode","funct3"],[35,1],function(core){var bytes=[];var value=core.registerFile.read(core.arguments[0]);bytes.push(value&255);value=value>>>8;bytes.push(value&255);if(core.memset(core.registerFile.read(core.arguments[2])+core.arguments[1],bytes)){core.pc+=4;return null}return"Illegal memory access."}));instructions.push(new Instruction("SW",sType,["opcode","funct3"],[35,2],function(core){var bytes=[];var value=core.registerFile.read(core.arguments[0]);bytes.push(value&255);value=value>>>8;bytes.push(value&255);value=value>>>8;bytes.push(value&255);value=value>>>8;bytes.push(value&255);if(core.memset(core.registerFile.read(core.arguments[2])+core.arguments[1],bytes)){core.pc+=4;return null}return"Illegal memory access."}));formats.push(new Format([new BitRange("imm",12,20,null,true).parameterized(1,Parameter.immediate),new BitRange("rd",7,5).parameterized(0,Parameter.offset),new BitRange("opcode",0,7)],/[a-zA-Z]+\s*([A-Za-z0-9]+)\s*,\s*([a-zA-Z0-9_]+)/,"@mnem @arg0, @arg1"));var uType=formats[formats.length-1];instructions.push(new Instruction("LUI",uType,["opcode"],[55],function(core){core.registerFile.write(core.arguments[0],core.arguments[1]<<12);core.pc+=4;return null}));instructions.push(new Instruction("AUIPC",uType,["opcode"],[23],function(core){core.registerFile.write(core.arguments[0],(core.arguments[1]<<12)+core.pc);core.pc+=4;return null}));formats.push(new Format([new BitRange("imm",25,7,null,true).parameterized(2,Parameter.special).limited(13,5,11),new BitRange("rs2",20,5).parameterized(1,Parameter.register),new BitRange("rs1",15,5).parameterized(0,Parameter.register),new BitRange("funct3",12,3),new BitRange("imm",7,5,null,true).parameterized(2,Parameter.special).limited(13,0,4),new BitRange("opcode",0,7)],/[a-zA-Z]+\s*([A-Za-z0-9]+)\s*,\s*([A-Za-z0-9]+)\s*,\s*([a-zA-Z0-9_]+)/,"@mnem @arg0, @arg1, @arg2",function(address,text,bits,labels,addresses){var array=text.split("");var result={errorMessage:null,value:null};var int=NaN;var labelLocation=labels.indexOf(text);if(labelLocation!==-1){int=addresses[labelLocation]-address+4}else{var radix=10>>>0;var splice=false;if(array[0]==="0"){if(array[1]=="b"){radix=2;splice=true}if(array[1]=="o"){radix=8;splice=true}if(array[1]=="d"){radix=10;splice=true}if(array[1]=="x"){radix=16;splice=true}}var interpretable=text;if(splice){interpretable=array.splice(2,array.length-2).join("")}int=parseInt(interpretable,radix)}if(isNaN(int)){result.errorMessage="Offset '"+text+"' is not a recognized label or literal.";return result}if(rangeCheck(int,13)){var mangle=int&2046;mangle=mangle|int>>>11&1;mangle=mangle|(int>>>12&1)<<11;result.value=mangle;return result}result.errorMessage="The value of '"+text+"' is out of range.";return result},function(value){var unmangle=(value&1)<<11;unmangle=unmangle|value>>>11<<12;unmangle=unmangle|value&2046;return unmangle}));var sbType=formats[formats.length-1];instructions.push(new Instruction("BEQ",sbType,["opcode","funct3"],[99,0],function(core){if(core.registerFile.read(core.arguments[0])===core.registerFile.read(core.arguments[1])){core.pc+=core.arguments[2]}return null}));instructions.push(new Instruction("BNE",sbType,["opcode","funct3"],[99,1],function(core){if(core.registerFile.read(core.arguments[0])!==core.registerFile.read(core.arguments[1])){core.pc+=core.arguments[2]}return null}));instructions.push(new Instruction("BLT",sbType,["opcode","funct3"],[99,4],function(core){if(core.registerFile.read(core.arguments[0])<core.registerFile.read(core.arguments[1])){core.pc+=core.arguments[2]}return null}));instructions.push(new Instruction("BGE",sbType,["opcode","funct3"],[99,5],function(core){if(core.registerFile.read(core.arguments[0])>=core.registerFile.read(core.arguments[1])){core.pc+=core.arguments[2]}return null}));instructions.push(new Instruction("BLTU",sbType,["opcode","funct3"],[99,6],function(core){if(core.registerFile.read(core.arguments[0])>>>0<core.registerFile.read(core.arguments[1])>>>0){core.pc+=core.arguments[2]}return null}));instructions.push(new Instruction("BGEU",sbType,["opcode","funct3"],[99,7],function(core){if(core.registerFile.read(core.arguments[0])>>>0>=core.registerFile.read(core.arguments[1])>>>0){core.pc+=core.arguments[2]}return null}));formats.push(new Format([new BitRange("imm",12,20,null,true).parameterized(1,Parameter.special).limited(21),new BitRange("rd",7,5).parameterized(0,Parameter.register),new BitRange("opcode",0,7)],/[a-zA-Z]+\s*([A-Za-z0-9]+)\s*,\s*([a-zA-Z0-9_]+)/,"@mnem @arg0, @arg1",function(address,text,bits,labels,addresses){var array=text.split("");var result={errorMessage:null,value:null};var int=NaN;var labelLocation=labels.indexOf(text);if(labelLocation!==-1){int=addresses[labelLocation]-address+4}else{var radix=10>>>0;var splice=false;if(array[0]==="0"){if(array[1]=="b"){radix=2;splice=true}if(array[1]=="o"){radix=8;splice=true}if(array[1]=="d"){radix=10;splice=true}if(array[1]=="x"){radix=16;splice=true}}var interpretable=text;if(splice){interpretable=array.splice(2,array.length-2).join("")}int=parseInt(interpretable,radix)}if(isNaN(int)){result.errorMessage="Offset '"+text+"' is not a recognized label or literal.";return result}if(rangeCheck(int,21)){var mangle=int>>12&255;mangle=mangle|(int>>11&1)<<8;mangle=mangle|(int>>1&1023)<<9;mangle=mangle|(int>>20&1)<<19;result.value=mangle;return result}result.errorMessage="The value of '"+text+"' ("+int.toString()+")is out of range.";return result},function(value){var unmangle=(value>>8&1)<<11;unmangle=unmangle|(value>>>19&1)<<20;unmangle=unmangle|(value>>>0&255)<<12;unmangle=unmangle|(value>>>9&1023)<<1;return unmangle}));var ujType=formats[formats.length-1];instructions.push(new Instruction("JAL",ujType,["opcode"],[111],function(core){core.registerFile.write(core.arguments[0],core.pc);core.pc+=core.arguments[1];return null}));formats.push(new Format([new BitRange("const",0,32)],/[a-zA-Z]+/,"@mnem"));var allConstSubtype=formats[formats.length-1];instructions.push(new Instruction("ECALL",allConstSubtype,["const"],[115],function(core){core.ecall();core.pc+=4;return null}));formats.push(new Format([new BitRange("funct7",25,7),new BitRange("rs2",20,5).parameterized(1,Parameter.register),new BitRange("rs1",15,5),new BitRange("funct3",12,3),new BitRange("rd",7,5).parameterized(0,Parameter.register),new BitRange("opcode",0,7)],/[a-zA-Z]+\s*([A-Za-z0-9]+)\s*,\s*([A-Za-z0-9]+)/,"@mnem @arg0, @arg1"));var mvPseudo=formats[formats.length-1];instructions.push(new Instruction("MV",mvPseudo,["opcode","funct3","rs1","funct7"],[51,0,parseInt("00000"),0],function(core){return null}));formats.push(new Format([new BitRange("imm",20,12,null,true).parameterized(1,Parameter.register),new BitRange("rs1",15,5),new BitRange("funct3",12,3),new BitRange("rd",7,5).parameterized(0,Parameter.register),new BitRange("opcode",0,7)],/[a-zA-Z]+\s*([A-Za-z0-9]+)\s*,\s*(-?[a-zA-Z0-9_]+)/,"@mnem @arg0, @arg1"));var liPseudo=formats[formats.length-1];instructions.push(new Instruction("LI",liPseudo,["opcode","funct3","rs1"],[19,0,0],function(core){return null}));instructions.push(new Instruction("LA",liPseudo,["opcode","funct3","rs1"],[19,0,0],function(core){return null}));formats.push(new Format([new BitRange("imm",20,12,null,true),new BitRange("rs1",15,5).parameterized(0,Parameter.register),new BitRange("funct3",12,3),new BitRange("rd",7,5),new BitRange("opcode",0,7)],/[a-zA-Z]+\s*([A-Za-z0-9]+)/,"@mnem @arg0"));var jrPseudo=formats[formats.length-1];instructions.push(new Instruction("JR",jrPseudo,["opcode","rd","funct3","imm"],[103,0,0,0],function(core){return null}));instructions.push(new Instruction("SCALL",allConstSubtype,["const"],[115],function(core){return null}));instructions.push(new Instruction("SYSCALL",allConstSubtype,["const"],[115],function(core){return null}));var process=function(address,text,type,bits,labels,addresses){var array=text.split("");var result={errorMessage:null,value:null};switch(type){case Parameter.register:var registerNo=parseInt(text);if(isNaN(registerNo)){var index=this.abiNames.indexOf(text);if(index!==-1){result.value=index;return result}}if(array[0]!=="x"){result.errorMessage="Register "+text+" does not exist.";return result}registerNo=parseInt(array.splice(1,array.length-1).join(""));if(0<=registerNo&&registerNo<=31){result.value=registerNo;return result}else{result.errorMessage="Register "+text+" does not exist.";return result}case Parameter.immediate:var int=NaN;var labelIndex=labels.indexOf(text);if(labelIndex!==-1){int=addresses[labelIndex]}else if(array.length===3&&array[0]=="'"&&array[2]=="'"){int=array[1].charCodeAt(0)}else{var radix=10>>>0;var splice=false;if(array[0]==="0"){if(array[1]=="b"){radix=2;splice=true}if(array[1]=="o"){radix=8;splice=true}if(array[1]=="d"){radix=10;splice=true}if(array[1]=="x"){radix=16;splice=true}}var interpretable=text;if(splice){interpretable=array.splice(2,array.length-2).join("")}int=parseInt(interpretable,radix)}if(isNaN(int)){result.errorMessage="Immediate '"+text+"' is not a recognized label, literal or character.";return result}console.log(text,int,bits);if(rangeCheck(int,bits)){result.value=int;return result}result.errorMessage="The value of '"+text+"' is out of range.";return result;case Parameter.offset:var int=NaN;var labelLocation=labels.indexOf(text);if(labelLocation!==-1){int=addresses[labelLocation]-address+4}else{var radix=10>>>0;var splice=false;if(array[0]==="0"){if(array[1]=="b"){radix=2;splice=true}if(array[1]=="o"){radix=8;splice=true}if(array[1]=="d"){radix=10;splice=true}if(array[1]=="x"){radix=16;splice=true}}var interpretable=text;if(splice){interpretable=array.splice(2,array.length-2).join("")}int=parseInt(interpretable,radix)}if(isNaN(int)){result.errorMessage="Offset '"+text+"' is not a recognized label or literal.";return result}if(rangeCheck(int,bits)){result.value=int;return result}result.errorMessage="The value of '"+text+"' is out of range.";return result;default:return result}};var tokenize=function(file){var result={errorMessage:null,labels:[],addresses:[],lines:[],pc:[]};var address=0;var text=true;var lines=file.split("\n");for(var i=0;i<lines.length;i++){var labelExtractor=/\s*(([A-Za-z_][A-Za-z0-9_]*):)?(.*)?/.exec(lines[i]);if(labelExtractor==null){console.log("Congratulations, you broke regular expressions.")}if(typeof labelExtractor[2]!=="undefined"){result.labels.push(labelExtractor[2]);result.addresses.push(address)}lines[i]=labelExtractor[3];if(lines[i]==undefined){continue}var chars=lines[i].split("");var inString=false;var commentOut=false;for(var j=0;j<chars.length;j++){if(!commentOut){if(chars[j]=='"'||chars[j]=="'"){inString=!inString}else if(inString){if(chars[j]=="\\"){j++}else if(chars[j]=="\n"){result.errorMessage="Line "+i+": Unterminated string.";return result}}else{if(chars[j]=="#"){commentOut=true;chars.splice(j,1);j--}}}else{if(chars[j]!=="\n"){chars.splice(j,1);j--}else{commentOut=false}}}lines[i]=chars.join("");lines[i]=lines[i].split("' '").join("32");var directives_1=lines[i].split(/\s+/).filter(function(value){return value.length>0});if(directives_1.length===0){continue}var directiveChars=directives_1[0].split("");if(text){if(directives_1[0]===".data"){text=false;if(directives_1[1]!==undefined){result.errorMessage="Line "+i+": "+directives_1[1]+" is extraneous. .data does not take any arguments.";return result}}else if(directives_1[0]===".text"){}else if(directiveChars[0]==="."){result.errorMessage="Line "+i+": "+directives_1[0]+" cannot be in the text section. Aborting.";return result}else{var instructionIndex=this.mnemonicSearch(directives_1[0].toUpperCase());if(instructionIndex===-1){var pseudoInstructionIndex=this.pseudoMnemonicSearch(directives_1[0].toUpperCase());if(pseudoInstructionIndex!==-1){address+=this.pseudoInstructions[pseudoInstructionIndex].expansion.length*4}else{result.errorMessage="Line "+i+": Instruction "+directives_1[0]+" not found.";return result}}else{address+=4}}}else{if(directives_1[0]==".text"){text=true;if(directives_1[1]!==undefined){result.errorMessage="Line "+i+": "+directives_1[1]+" is extraneous. .text does not take any arguments.";return result}}else if(directives_1[0]===".data"){}else if(this.dataDirectives.indexOf(directives_1[0])!==-1){var index=this.dataDirectives.indexOf(directives_1[0]);if(this.dataDirectiveSizes[index]!==0){var array=directives_1.join(" ").split(directives_1[i]).join("").split(",");address+=array.length*this.dataDirectiveSizes[index]}else{switch(directives_1[0]){case".string":var match=/.string\s*\"(.*)\"\s*(#.*)?$/.exec(lines[i]);if(match==null){result.errorMessage="Line "+i+": Malformed string directive.";return result}var array=match[1].split("");for(var j=0;j<array.length;j++){if(array[j]=="\\"){j++}address+=1}address+=1}}}else if(directiveChars[0]==="."){result.errorMessage="Line "+i+": Unsupported directive "+directives_1[0]+".";return result}else{result.errorMessage="Line "+i+": Unrecognized keyword "+directives_1[0]+".";return result}}result.pc.push(address)}result.lines=lines;return result};var assemble=function(nester,address,lines,labels,addresses){if(nester===void 0){nester=null}var result={errorMessage:null,machineCode:[],size:0};var text=true;for(var i=0;i<lines.length;i++){if(typeof lines[i]=="undefined"){continue}var directives_2=lines[i].split(/\s+/).filter(function(value){return value.length>0});if(directives_2.length===0){continue}if(text){if(directives_2[0]===".data"){text=false}else if(directives_2[0]===".text"){}else{address+=4;var instructionIndex=this.mnemonicSearch(directives_2[0].toUpperCase());if(instructionIndex===-1){result.errorMessage="Line "+(nester==null?"":nester+":")+i+": Instruction "+directives_2[0]+" not found.";return result}var instruction=this.instructions[instructionIndex];var format=instruction.format;var bitRanges=format.ranges;var regex=format.regex;var params=format.parameters;var paramTypes=format.parameterTypes;var machineCode=instruction.template();var match=regex.exec(lines[i]);if(match==null){result.errorMessage="Line "+(nester==null?"":nester+":")+i+": Argument format for "+directives_2[0]+" violated.";return result}var args=match.splice(1,params.length);for(var j=0;j<bitRanges.length;j++){if(bitRanges[j].parameter!=null){var startBit=0;var endBit=null;var bits=bitRanges[j].bits;var field=bitRanges[j].field;var limits=/([A-za-z]+)\s*\[\s*(\d+)\s*:\s*(\d+)\s*\]/.exec(bitRanges[j].field);if(limits!=null){field=limits[1];bits=bitRanges[j].limitlessBits}var index=format.fieldParameterIndex(field);var register=0;if(paramTypes[index]!==Parameter.special){var processed_1=this.processParameter(address,args[index],paramTypes[index],bits,labels,addresses);if(processed_1.errorMessage!==null){result.errorMessage="Line "+(nester==null?"":nester+":")+i+": "+processed_1.errorMessage;return result}register=processed_1.value}else{var processed_2=instruction.format.processSpecialParameter(address,args[index],bits,labels,addresses);if(processed_2.errorMessage!==null){result.errorMessage="Line "+(nester==null?"":nester+":")+i+": "+processed_2.errorMessage;return result}register=processed_2.value}if(limits!=null){startBit=parseInt(limits[3]);endBit=parseInt(limits[2]);register=register>>>startBit;register=register&(1<<endBit-startBit+1)-1}machineCode=machineCode|register<<bitRanges[j].start}}for(var j=0;j<4;j++){result.machineCode.push(machineCode&255);machineCode=machineCode>>>8}}}else{if(directives_2[0]==".text"){text=true}else if(this.dataDirectives.indexOf(directives_2[0])!==-1){var index=this.dataDirectives.indexOf(directives_2[0]);if(this.dataDirectiveSizes[index]!==0){var size=this.dataDirectiveSizes[index];var array=lines[i].split("' '").join("'$OAK_SPACE_TEMP'").split(directives_2[0]).join("").split(" ").join("").split("'$OAK_SPACE_TEMP'").join("' '").split(",");for(var j=0;j<array.length;j++){var processed=this.processParameter(address,array[j],Parameter.immediate,size*8,labels,addresses);if(processed.errorMessage!==null){result.errorMessage="Line "+(nester==null?"":nester+":")+i+": "+processed.errorMessage;return result}for(var k=0;k<size;k++){address+=1;result.machineCode.push(processed.value&255);processed.value=processed.value>>>8}}}else{switch(directives_2[0]){case".string":var stringMatch=/.string\s*\"(.*)\"\s*(#.*)?$/.exec(lines[i]);if(stringMatch==null){result.errorMessage="Line "+i+": Malformed string directive.";return result}if(stringMatch[1]==undefined){stringMatch[1]=""}var characters=stringMatch[1].split("");for(var j=0;j<characters.length;j++){if(characters[j]=="\\"){j++;if(j+1<characters.length){switch(characters[j+1]){case"n":result.machineCode.push(10>>>0);break;case"0":result.machineCode.push(0>>>0);break;case"'":result.machineCode.push(39>>>0);break;case"\\":result.machineCode.push(92>>>0);break;default:result.machineCode.push(characters[j].charCodeAt(0))}}}else{result.machineCode.push(characters[j].charCodeAt(0))}address+=1}result.machineCode.push(0>>>0);address+=1}}}}}result.size=address;return result};var abiNames=["zero","ra","sp","gp","tp","t0","t1","t2","s0","s1","a0","a1","a2","a3","a4","a5","a6","a7","s2","s3","s4","s5","s6","s7","s8","s9","s10","s11","t3","t4","t5","t6"];var keywords=[];keywords[Keyword.directive]=["\\."];keywords[Keyword.comment]=["#"];keywords[Keyword.label]=["\\:"];keywords[Keyword.stringMarker]=['\\"'];keywords[Keyword.charMarker]=["\\'"];keywords[Keyword.register]=["x"];var directives=[];directives["text"]=Directive.text;directives["data"]=Directive.data;directives["string"]=Directive.cString;directives["byte"]=Directive._8bit;directives["half"]=Directive._16bit;directives["word"]=Directive._32bit;return new InstructionSet("rv32i",32,formats,instructions,pseudoInstructions,[".word",".half",".byte",".string"],[4,2,1,0],abiNames,process,tokenize,assemble,keywords,directives)}var RISCV=Oak_gen_RISCV();var RISCVRegisterFile=function(){function RISCVRegisterFile(memorySize,abiNames){this.physicalFile=[];this.modifiedRegisters=[];for(var i=0;i<32;i++){this.physicalFile.push(0);this.modifiedRegisters.push(false)}this.memorySize=memorySize;this.physicalFile[2]=memorySize;this.abiNames=abiNames}RISCVRegisterFile.prototype.print=function(){console.log("Registers\n------");for(var i=0;i<32;i++){console.log("x"+i.toString(),this.abiNames[i],this.physicalFile[i].toString(),(this.physicalFile[i]>>>0).toString(16).toUpperCase())}console.log("------")};RISCVRegisterFile.prototype.read=function(registerNumber){if(registerNumber===0){return 0}else{return this.physicalFile[registerNumber]}};RISCVRegisterFile.prototype.write=function(registerNumber,value){this.physicalFile[registerNumber]=value;this.modifiedRegisters[registerNumber]=true};RISCVRegisterFile.prototype.getRegisterCount=function(){return 32};RISCVRegisterFile.prototype.getModifiedRegisters=function(){var modReg=this.modifiedRegisters.slice();for(var i=0;i<this.getRegisterCount();i++){this.modifiedRegisters[i]=false}return modReg};RISCVRegisterFile.prototype.reset=function(){for(var i=0;i<32;i++){this.physicalFile[i]=0;this.modifiedRegisters[i]=false}this.physicalFile[2]=this.memorySize};return RISCVRegisterFile}();var RISCVCore=function(_super){__extends(RISCVCore,_super);function RISCVCore(memorySize,ecall,instructionCallback){var _this=_super.call(this)||this;_this.defaultEcallRegType=17;_this.defaultEcallRegArg=10;_this.aceStyle="ace/mode/riscv";_this.defaultCode='    la a0, str\n    li a7, 4 #4 is the string print service number...\n    ecall\n    li a7, 10 #...and 10 is the program termination service number!\n    ecall\n.data\nstr:    .string "Hello, World!"';_this.defaultMachineCode="13 05 40 01 93 08 40 00 73 00 00 00 93 08 A0 00 73 00 00 00 48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 21 00 ";_this.instructionSet=RISCV;_this.pc=0>>>0;_this.memorySize=memorySize;_this.ecall=ecall;_this.instructionCallback=instructionCallback;_this.registerFile=new RISCVRegisterFile(memorySize,RISCV.abiNames);_this.memory=new Array(memorySize);for(var i=0;i<memorySize;i++){_this.memory[i]=0}return _this}RISCVCore.prototype.reset=function(){this.pc=0;this.memory=[];for(var i=0;i<this.memorySize;i++){this.memory[i]=0}this.registerFile.reset()};RISCVCore.prototype.fetch=function(){if(this.pc<0){return"Fetch Error: Negative program counter."}var arr=this.memcpy(this.pc,4);if(arr==null){return"Fetch Error: Illegal memory access."}this.fetched=catBytes(arr);return null};return RISCVCore}(Core);function Oak_gen_MIPS(){var formats=[];var instructions=[];var pseudoInstructions=[];formats.push(new Format([new BitRange("opcode",26,6),new BitRange("rs",21,5).parameterized(1,Parameter.register),new BitRange("rt",16,5).parameterized(2,Parameter.register),new BitRange("rd",11,5).parameterized(0,Parameter.register),new BitRange("shamt",6,5,0),new BitRange("funct",0,6)],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)\s*,\s*(\$[A-Za-z0-9]+)\s*,\s*(\$[A-Za-z0-9]+)/,"@mnem @arg0, @arg1, @arg2"));var rType=formats[formats.length-1];instructions.push(new Instruction("ADD",rType,["opcode","funct"],[0,32],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])+core.registerFile.read(core.arguments[2]));return null}));instructions.push(new Instruction("ADDU",rType,["opcode","funct"],[0,33],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])+core.registerFile.read(core.arguments[2]));return null}));instructions.push(new Instruction("SUB",rType,["opcode","funct"],[0,34],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])-core.registerFile.read(core.arguments[2]));return null}));instructions.push(new Instruction("SUBU",rType,["opcode","funct"],[0,35],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])-core.registerFile.read(core.arguments[2]));return null}));instructions.push(new Instruction("AND",rType,["opcode","funct"],[0,36],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])&core.registerFile.read(core.arguments[2]));return null}));instructions.push(new Instruction("OR",rType,["opcode","funct"],[0,37],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])|core.registerFile.read(core.arguments[2]));return null}));instructions.push(new Instruction("NOR",rType,["opcode","funct"],[0,39],function(core){core.registerFile.write(core.arguments[0],~(core.registerFile.read(core.arguments[1])|core.registerFile.read(core.arguments[2])));return null}));instructions.push(new Instruction("XOR",rType,["opcode","funct"],[0,38],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])^core.registerFile.read(core.arguments[2]));return null}));instructions.push(new Instruction("SLT",rType,["opcode","funct"],[0,42],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])<core.registerFile.read(core.arguments[2])?1:0);return null}));instructions.push(new Instruction("SLLV",rType,["opcode","funct"],[0,4],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])<<core.registerFile.read(core.arguments[2]));return null}));instructions.push(new Instruction("SRLV",rType,["opcode","funct"],[0,6],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>>core.registerFile.read(core.arguments[2]));return null}));instructions.push(new Instruction("SRAV",rType,["opcode","funct"],[0,7],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>core.registerFile.read(core.arguments[2]));return null}));formats.push(new Format([new BitRange("opcode",26,6),new BitRange("rs",21,5).parameterized(0,Parameter.register),new BitRange("rt",16,5,0),new BitRange("rd",11,5,0),new BitRange("shamt",6,5,0),new BitRange("funct",0,6)],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)/,"@mnem @arg0"));var rjSubtype=formats[formats.length-1];instructions.push(new Instruction("JR",rjSubtype,["opcode","funct"],[0,8],function(core){core.pc=core.registerFile.read(core.arguments[0]);return null}));formats.push(new Format([new BitRange("opcode",26,6),new BitRange("rs",21,5,0),new BitRange("rt",16,5).parameterized(1,Parameter.register),new BitRange("rd",11,5).parameterized(0,Parameter.register),new BitRange("shamt",6,5).parameterized(2,Parameter.immediate),new BitRange("funct",0,6)],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)\s*,\s*(\$[A-Za-z0-9]+)\s*,\s*([0-9]+)/,"@mnem @arg0, @arg1, @arg2"));var rsSubtype=formats[formats.length-1];instructions.push(new Instruction("SLL",rsSubtype,["opcode","funct"],[0,0],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])<<core.arguments[2]);return null}));instructions.push(new Instruction("SRL",rsSubtype,["opcode","funct"],[0,2],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>>core.arguments[2]);return null}));instructions.push(new Instruction("SRA",rsSubtype,["opcode","funct"],[0,2],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>core.arguments[2]);return null}));formats.push(new Format([new BitRange("funct",0,32)],/[a-zA-Z]+/,"@mnem"));var rcSubtype=formats[formats.length-1];instructions.push(new Instruction("SYSCALL",rcSubtype,["funct"],[12],function(core){core.ecall();return null}));formats.push(new Format([new BitRange("opcode",26,6),new BitRange("rs",21,5).parameterized(1,Parameter.register),new BitRange("rt",16,5).parameterized(0,Parameter.register),new BitRange("imm",0,16,null,true).parameterized(2,Parameter.immediate)],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)\s*,\s*(\$[A-Za-z0-9]+)\s*,\s*(-?[a-zA-Z0-9_]+)/,"@mnem @arg0, @arg1, @arg2"));var iType=formats[formats.length-1];instructions.push(new Instruction("ADDI",iType,["opcode"],[8],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])+core.arguments[2]);return null}));instructions.push(new Instruction("ADDIU",iType,["opcode"],[9],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])+core.arguments[2]);return null}));instructions.push(new Instruction("SLTI",iType,["opcode"],[10],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])<core.arguments[2]?1:0);return null}));instructions.push(new Instruction("SLTIU",iType,["opcode"],[11],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>>0<core.arguments[2]>>>0?1:0);return null}));instructions.push(new Instruction("ANDI",iType,["opcode"],[12],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>>0&core.arguments[2]);return null}));instructions.push(new Instruction("ORI",iType,["opcode"],[13],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>>0|core.arguments[2]);return null}));instructions.push(new Instruction("XORI",iType,["opcode"],[14],function(core){core.registerFile.write(core.arguments[0],core.registerFile.read(core.arguments[1])>>>0^core.arguments[2]);return null}));formats.push(new Format([new BitRange("opcode",26,6),new BitRange("rs",21,5).parameterized(0,Parameter.register),new BitRange("rt",16,5).parameterized(1,Parameter.register),new BitRange("imm",0,16,null,true).parameterized(2,Parameter.immediate)],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)\s*,\s*(\$[A-Za-z0-9]+)\s*,\s*(-?[a-zA-Z0-9_]+)/,"@mnem @arg0, @arg1, @arg2",function(address,text,bits,labels,addresses){var array=text.split("");var result={errorMessage:null,value:null};var int=NaN;var labelLocation=labels.indexOf(text);if(labelLocation!==-1){int=addresses[labelLocation]}else{var radix=10>>>0;var splice=false;if(array[0]==="0"){if(array[1]=="b"){radix=2;splice=true}if(array[1]=="o"){radix=8;splice=true}if(array[1]=="d"){radix=10;splice=true}if(array[1]=="x"){radix=16;splice=true}}var interpretable=text;if(splice){interpretable=array.splice(2,array.length-2).join("")}int=parseInt(interpretable,radix)}if(isNaN(int)){result.errorMessage="Offset '"+text+"' is not a recognized label or literal.";return result}if((int&3)!=0){result.errorMessage="Branches must be word-aligned.";return result}int-=address;int>>=2;if(rangeCheck(int,16)){result.value=int;return result}result.errorMessage="The value of '"+text+"' is out of range.";return result},function(value,address){return value<<2}));var ibSubtype=formats[formats.length-1];instructions.push(new Instruction("BEQ",ibSubtype,["opcode"],[4],function(core){if(core.registerFile.read(core.arguments[0])===core.registerFile.read(core.arguments[1])){core.pc+=core.arguments[2]}return null}));instructions.push(new Instruction("BNE",ibSubtype,["opcode"],[5],function(core){if(core.registerFile.read(core.arguments[0])!==core.registerFile.read(core.arguments[1])){core.pc+=core.arguments[2]}return null}));formats.push(new Format([new BitRange("opcode",26,6),new BitRange("rs",21,5,0),new BitRange("rt",16,5).parameterized(0,Parameter.register),new BitRange("imm",0,16,null,true).parameterized(1,Parameter.register)],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)\s*,\s*(-?[a-zA-Z0-9_]+)/,"@mnem @arg0, @arg1"));var iluiSubtype=formats[formats.length-1];instructions.push(new Instruction("LUI",iluiSubtype,["opcode"],[15],function(core){core.registerFile.write(core.arguments[0],core.arguments[1]<<16);return null}));formats.push(new Format([new BitRange("opcode",26,6),new BitRange("rs",21,5).parameterized(2,Parameter.register),new BitRange("rt",16,5).parameterized(0,Parameter.register),new BitRange("imm",0,16,null,true).parameterized(1,Parameter.immediate)],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)\s*,\s*(-?0?[boxd]?[0-9A-F]+)\(\s*(\$[A-Za-z0-9]+)\s*\)/,"@mnem @arg0, @arg1(@arg2)"));var ilsSubtype=formats[formats.length-1];instructions.push(new Instruction("LB",ilsSubtype,["opcode"],[32],function(core){var bytes=core.memcpy(core.registerFile.read(core.arguments[2])+core.arguments[1],1);if(bytes===null){return"Illegal memory access."}core.registerFile.write(core.arguments[0],signExt(bytes[0],8));return null}));instructions.push(new Instruction("LH",ilsSubtype,["opcode"],[33],function(core){var bytes=core.memcpy(core.registerFile.read(core.arguments[2])+core.arguments[1],2);if(bytes===null){return"Illegal memory access."}core.registerFile.write(core.arguments[0],signExt(catBytes(bytes),16));return null}));instructions.push(new Instruction("LW",ilsSubtype,["opcode"],[35],function(core){var bytes=core.memcpy(core.registerFile.read(core.arguments[2])+core.arguments[1],4);if(bytes===null){return"Illegal memory access."}core.registerFile.write(core.arguments[0],catBytes(bytes));return null}));instructions.push(new Instruction("LBU",ilsSubtype,["opcode"],[36],function(core){var bytes=core.memcpy(core.registerFile.read(core.arguments[2])+core.arguments[1],1);if(bytes===null){return"Illegal memory access."}core.registerFile.write(core.arguments[0],bytes[0]);return null}));instructions.push(new Instruction("LHU",ilsSubtype,["opcode"],[37],function(core){var bytes=core.memcpy(core.registerFile.read(core.arguments[2])+core.arguments[1],2);if(bytes===null){return"Illegal memory access."}core.registerFile.write(core.arguments[0],catBytes(bytes));return null}));instructions.push(new Instruction("SB",ilsSubtype,["opcode"],[40],function(core){var bytes=[];bytes.push(core.registerFile.read(core.arguments[0])&255);if(core.memset(core.registerFile.read(core.arguments[2])+core.arguments[1],bytes)){return null}return"Illegal memory access."}));instructions.push(new Instruction("SH",ilsSubtype,["opcode"],[41],function(core){var bytes=[];var value=core.registerFile.read(core.arguments[0]);bytes.push(value&255);value=value>>>8;bytes.push(value&255);if(core.memset(core.registerFile.read(core.arguments[2])+core.arguments[1],bytes)){return null}return"Illegal memory access."}));instructions.push(new Instruction("SW",ilsSubtype,["opcode"],[43],function(core){var bytes=[];var value=core.registerFile.read(core.arguments[0]);bytes.push(value&255);value=value>>>8;bytes.push(value&255);value=value>>>8;bytes.push(value&255);value=value>>>8;bytes.push(value&255);if(core.memset(core.registerFile.read(core.arguments[2])+core.arguments[1],bytes)){return null}return"Illegal memory access."}));formats.push(new Format([new BitRange("opcode",26,6),new BitRange("imm",0,26).parameterized(0,Parameter.special).limited(32)],/[A-z]+\s*([A-Za-z0-9_]+)/,"@mnem @arg0",function(address,text,bits,labels,addresses){var array=text.split("");var result={errorMessage:null,value:null};var int=NaN;var labelLocation=labels.indexOf(text);if(labelLocation!==-1){int=addresses[labelLocation]}else{var radix=10>>>0;var splice=false;if(array[0]==="0"){if(array[1]=="b"){radix=2;splice=true}if(array[1]=="o"){radix=8;splice=true}if(array[1]=="d"){radix=10;splice=true}if(array[1]=="x"){radix=16;splice=true}}var interpretable=text;if(splice){interpretable=array.splice(2,array.length-2).join("")}int=parseInt(interpretable,radix)}if(isNaN(int)){result.errorMessage="Offset '"+text+"' is not a recognized label or literal.";return result}if(int>>>28==address>>>28){if((int&3)==0){result.value=(int&268435452)>>>2;return result}result.errorMessage="Jumps must be word-aligned.";return result}result.errorMessage="The value of '"+text+"' is out of range.";return result},function(value,address){return value<<2|address&4026531840}));var jType=formats[formats.length-1];instructions.push(new Instruction("J",jType,["opcode"],[2],function(core){core.pc=core.arguments[0];return null}));instructions.push(new Instruction("JAL",jType,["opcode"],[3],function(core){core.registerFile.write(31,core.pc);core.pc=core.arguments[0];return null}));formats.push(new Format([new BitRange("opcode",26,6),new BitRange("rs",21,5).parameterized(1,Parameter.register),new BitRange("rt",16,5,0),new BitRange("rd",11,5).parameterized(0,Parameter.register),new BitRange("shamt",6,5,0),new BitRange("funct",0,6)],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)\s*,\s*(\$[A-Za-z0-9]+)/,"@mnem @arg0, @arg1"));var mvPseudo=formats[formats.length-1];instructions.push(new Instruction("MV",mvPseudo,["opcode","funct"],[0,32],function(core){return null}));formats.push(new Format([new BitRange("opcode",26,6),new BitRange("rs",21,5,0),new BitRange("rt",16,5).parameterized(0,Parameter.register),new BitRange("imm",0,16,null,true).parameterized(1,Parameter.immediate)],/[a-zA-Z]+\s*(\$[A-Za-z0-9]+)\s*,\s*(-?[a-zA-Z0-9_]+)/,"@mnem @arg0, @arg1"));var liPseudo=formats[formats.length-1];instructions.push(new Instruction("LI",liPseudo,["opcode"],[8],function(core){return null}));instructions.push(new Instruction("LA",liPseudo,["opcode"],[8],function(core){return null}));var process=function(address,text,type,bits,labels,addresses){var array=text.split("");var result={errorMessage:null,value:null};switch(type){case Parameter.register:var registerNo;var index=this.abiNames.indexOf(text);if(index!==-1){result.value=index;return result}if(array[0]!=="$"){result.errorMessage="Register "+text+" does not exist.";return result}registerNo=parseInt(array.splice(1,array.length-1).join(""));if(0<=registerNo&&registerNo<=31){result.value=registerNo;return result}else{result.errorMessage="Register "+text+" does not exist.";return result}case Parameter.immediate:var int=NaN;var labelIndex=labels.indexOf(text);if(labelIndex!==-1){int=addresses[labelIndex]}else if(array.length===3&&array[0]=="'"&&array[2]=="'"){int=array[1].charCodeAt(0)}else{var radix=10>>>0;var splice=false;if(array[0]==="0"){if(array[1]=="b"){radix=2;splice=true}if(array[1]=="o"){radix=8;splice=true}if(array[1]=="d"){radix=10;splice=true}if(array[1]=="x"){radix=16;splice=true}}var interpretable=text;if(splice){interpretable=array.splice(2,array.length-2).join("")}int=parseInt(interpretable,radix)}if(isNaN(int)){result.errorMessage="Immediate '"+text+"' is not a recognized label, literal or character.";return result}if(rangeCheck(int,bits)){result.value=int;return result}result.errorMessage="The value of '"+text+"' is out of range.";return result;case Parameter.offset:var int=NaN;var labelLocation=labels.indexOf(text);if(labelLocation!==-1){int=addresses[labelLocation]-address}else{var radix=10>>>0;var splice=false;if(array[0]==="0"){if(array[1]=="b"){radix=2;splice=true}if(array[1]=="o"){radix=8;splice=true}if(array[1]=="d"){radix=10;splice=true}if(array[1]=="x"){radix=16;splice=true}}var interpretable=text;if(splice){interpretable=array.splice(2,array.length-2).join("")}int=parseInt(interpretable,radix)}if(isNaN(int)){result.errorMessage="Offset '"+text+"' is not a recognized label or literal.";return result}if(rangeCheck(int,bits)){result.value=int;return result}result.errorMessage="The value of '"+text+"' is out of range.";return result;default:return result}};var tokenize=function(file){var result={errorMessage:null,labels:[],addresses:[],lines:[],pc:[]};var address=0;var text=true;var lines=file.split("\n");for(var i=0;i<lines.length;i++){var labelExtractor=/\s*(([A-Za-z_][A-Za-z0-9_]*):)?(.*)?/.exec(lines[i]);if(labelExtractor==null){console.log("Congratulations, you broke regular expressions.")}if(typeof labelExtractor[2]!=="undefined"){result.labels.push(labelExtractor[2]);result.addresses.push(address)}lines[i]=labelExtractor[3];if(lines[i]==undefined){continue}var chars=lines[i].split("");var inString=false;var commentOut=false;for(var j=0;j<chars.length;j++){if(!commentOut){if(chars[j]=='"'||chars[j]=="'"){inString=!inString}else if(inString){if(chars[j]=="\\"){j++}else if(chars[j]=="\n"){result.errorMessage="Line "+i+": Unterminated string.";return result}}else{if(chars[j]=="#"){commentOut=true;chars.splice(j,1);j--}}}else{if(chars[j]!=="\n"){chars.splice(j,1);j--}else{commentOut=false}}}lines[i]=chars.join("");lines[i]=lines[i].split("' '").join("32");var directives_3=lines[i].split(" ").filter(function(value){return value.length>0});if(directives_3.length===0){continue}var directiveChars=directives_3[0].split("");if(text){if(directives_3[0]===".data"){text=false;if(directives_3[1]!==undefined){result.errorMessage="Line "+i+": "+directives_3[1]+" is extraneous. .data does not take any arguments.";return result}}else if(directives_3[0]===".text"){}else if(directiveChars[0]==="."){result.errorMessage="Line "+i+": "+directives_3[0]+" cannot be in the text section. Aborting.";return result}else{address+=4;var instructionIndex=this.mnemonicSearch(directives_3[0].toUpperCase());if(instructionIndex===-1){result.errorMessage="Line "+i+": Instruction "+directives_3[0]+" not found.";return result}}}else{if(directives_3[0]==".text"){text=true;if(directives_3[1]!==undefined){result.errorMessage="Line "+i+": "+directives_3[1]+" is extraneous. .text does not take any arguments.";return result}}else if(directives_3[0]===".data"){}else if(this.dataDirectives.indexOf(directives_3[0])!==-1){var index=this.dataDirectives.indexOf(directives_3[0]);if(this.dataDirectiveSizes[index]!==0){var array=directives_3.join(" ").split(directives_3[i]).join("").split(",");address+=array.length*this.dataDirectiveSizes[index]}else{switch(directives_3[0]){case".asciiz":case".ascii":var match=/.([A-Za-z]+?)\s*\"(.*)\"\s*(#.*)?$/.exec(lines[i]);if(match==null){result.errorMessage="Line "+i+": Malformed string directive.";return result}var array=match[1].split("");for(var j=0;j<array.length;j++){if(array[j]=="\\"){j++}address+=1}if(directives_3[0]==".asciiz"){address+=1}}}}else if(directiveChars[0]==="."){result.errorMessage="Line "+i+": Unsupported directive "+directives_3[0]+".";return result}else{result.errorMessage="Line "+i+": Unrecognized keyword "+directives_3[0]+".";return result}}result.pc.push(address)}result.lines=lines;return result};var assemble=function(nester,address,lines,labels,addresses){if(nester===void 0){nester=null}var result={errorMessage:null,machineCode:[],size:0};var text=true;for(var i=0;i<lines.length;i++){if(typeof lines[i]=="undefined"){continue}var directives_4=lines[i].split(" ").filter(function(value){return value.length>0});if(directives_4.length===0){continue}if(text){if(directives_4[0]===".data"){text=false}else if(directives_4[0]===".text"){}else{address+=4;var instructionIndex=this.mnemonicSearch(directives_4[0].toUpperCase());if(instructionIndex===-1){result.errorMessage="Line "+(nester==null?"":nester+":")+i+": Instruction "+directives_4[0]+" not found.";return result}var instruction=this.instructions[instructionIndex];var format=instruction.format;var bitRanges=format.ranges;var regex=format.regex;var params=format.parameters;var paramTypes=format.parameterTypes;var machineCode=instruction.template();var match=regex.exec(lines[i]);if(match==null){result.errorMessage="Line "+(nester==null?"":nester+":")+i+": Argument format for "+directives_4[0]+" violated.";return result}var args=match.splice(1,params.length);for(var j=0;j<bitRanges.length;j++){if(bitRanges[j].parameter!=null){var startBit=0;var endBit=null;var bits=bitRanges[j].bits;var field=bitRanges[j].field;var limits=/([A-za-z]+)\s*\[\s*(\d+)\s*:\s*(\d+)\s*\]/.exec(bitRanges[j].field);if(limits!=null){field=limits[1];bits=bitRanges[j].limitlessBits}var index=format.fieldParameterIndex(field);var register=0;if(paramTypes[index]!==Parameter.special){var processed_3=this.processParameter(address,args[bitRanges[j].parameter],paramTypes[index],bits,labels,addresses);if(processed_3.errorMessage!==null){result.errorMessage="Line "+(nester==null?"":nester+":")+i+": "+processed_3.errorMessage;return result}register=processed_3.value}else{var processed_4=instruction.format.processSpecialParameter(address,args[index],bits,labels,addresses);if(processed_4.errorMessage!==null){result.errorMessage="Line "+(nester==null?"":nester+":")+i+": "+processed_4.errorMessage;return result}register=processed_4.value}if(limits!=null){startBit=parseInt(limits[3]);endBit=parseInt(limits[2]);register=register>>>startBit;register=register&(1<<endBit-startBit+1)-1}machineCode=machineCode|(register&(1<<bitRanges[j].bits)-1)<<bitRanges[j].start}}for(var j=0;j<4;j++){result.machineCode.push(machineCode&255);machineCode=machineCode>>>8}}}else{if(directives_4[0]==".text"){text=true}else if(this.dataDirectives.indexOf(directives_4[0])!==-1){var index=this.dataDirectives.indexOf(directives_4[0]);if(this.dataDirectiveSizes[index]!==0){var size=this.dataDirectiveSizes[index];var array=lines[i].split("' '").join("'$OAK_SPACE_TEMP'").split(directives_4[0]).join("").split(" ").join("").split("'$OAK_SPACE_TEMP'").join("' '").split(",");for(var j=0;j<array.length;j++){var processed=this.processParameter(address,array[j],Parameter.immediate,size*8,labels,addresses);if(processed.errorMessage!==null){result.errorMessage="Line "+(nester==null?"":nester+":")+i+": "+processed.errorMessage;return result}for(var k=0;k<size;k++){address+=1;result.machineCode.push(processed.value&255);processed.value=processed.value>>>8}}}else{switch(directives_4[0]){case".asciiz":case".ascii":var stringMatch=/\s*(\.asciiz?)\s*\"(.*)\"\s*(#.*)?$/.exec(lines[i]);if(stringMatch==null){result.errorMessage="Line "+i+": Malformed string directive.";return result}if(stringMatch[2]==undefined){stringMatch[2]=""}var characters=stringMatch[2].split("");for(var j=0;j<characters.length;j++){if(characters[j]=="\\"){j++;if(j+1<characters.length){switch(characters[j+1]){case"n":result.machineCode.push(10>>>0);break;case"0":result.machineCode.push(0>>>0);break;case"'":result.machineCode.push(39>>>0);break;case"\\":result.machineCode.push(92>>>0);break;default:result.machineCode.push(characters[j].charCodeAt(0))}}}else{result.machineCode.push(characters[j].charCodeAt(0))}address+=1}if(stringMatch[1]==".asciiz"){result.machineCode.push(0>>>0);address+=1}}}}}}result.size=address;return result};var keywords=[];keywords[Keyword.directive]=["\\."];keywords[Keyword.comment]=["#"];keywords[Keyword.label]=["\\:"];keywords[Keyword.stringMarker]=['\\"'];keywords[Keyword.charMarker]=["\\'"];keywords[Keyword.register]=["x"];var directives=[];directives["text"]=Directive.text;directives["data"]=Directive.data;directives["asciiz"]=Directive.cString;directives["byte"]=Directive._8bit;directives["half"]=Directive._16bit;directives["word"]=Directive._32bit;var abiNames=["$zero","$at","$v0","$v1","$a0","$a1","$a2","$a3","$t0","$t1","$t2","$t3","$t4","$t5","$t6","$t7","$s0","$s1","$s2","$s3","$s4","$s5","$s6","$s7","$t8","$t9","$k0","$k1","$gp","$sp","$fp","$ra"];return new InstructionSet("mips",32,formats,instructions,pseudoInstructions,[".word",".half",".byte",".asciiz"],[4,2,1,0],abiNames,process,tokenize,assemble,keywords,directives)}var MIPS=Oak_gen_MIPS();var MIPSRegisterFile=function(){function MIPSRegisterFile(memorySize,abiNames){this.physicalFile=[];this.modifiedRegisters=[];for(var i=0;i<32;i++){this.physicalFile.push(0);this.modifiedRegisters.push(false)}this.memorySize=memorySize;this.physicalFile[29]=memorySize;this.abiNames=abiNames}MIPSRegisterFile.prototype.print=function(){console.log("Registers\n------");for(var i=0;i<32;i++){console.log("$"+i.toString(),this.abiNames[i],this.physicalFile[i].toString(),(this.physicalFile[i]>>>0).toString(16).toUpperCase())}console.log("------")};MIPSRegisterFile.prototype.read=function(registerNumber){if(registerNumber===0){return 0}else{return this.physicalFile[registerNumber]}};MIPSRegisterFile.prototype.write=function(registerNumber,value){this.physicalFile[registerNumber]=value;this.modifiedRegisters[registerNumber]=true};MIPSRegisterFile.prototype.getRegisterCount=function(){return 32};MIPSRegisterFile.prototype.getModifiedRegisters=function(){var modReg=this.modifiedRegisters.slice();for(var i=0;i<this.getRegisterCount();i++){this.modifiedRegisters[i]=false}return modReg};MIPSRegisterFile.prototype.reset=function(){for(var i=0;i<32;i++){this.physicalFile[i]=0;this.modifiedRegisters[i]=false}this.physicalFile[29]=this.memorySize};return MIPSRegisterFile}();var MIPSCore=function(_super){__extends(MIPSCore,_super);function MIPSCore(memorySize,ecall,instructionCallback){var _this=_super.call(this)||this;_this.defaultEcallRegType=2;_this.defaultEcallRegArg=4;_this.aceStyle="ace/mode/mips";_this.defaultCode='    la $a0, str\n    li $v0, 4 #4 is the string print service number...\n    syscall\n    li $v0, 10 #...and 10 is the program termination service number!\n    syscall\n.data\nstr:    .asciiz "Hello, World!"';_this.instructionSet=MIPS;_this.pc=0>>>0;_this.memorySize=memorySize;_this.ecall=ecall;_this.instructionCallback=instructionCallback;_this.registerFile=new MIPSRegisterFile(memorySize,MIPS.abiNames);_this.memory=new Array(memorySize);for(var i=0;i<memorySize;i++){_this.memory[i]=0}return _this}MIPSCore.prototype.reset=function(){this.pc=0;this.memory=[];for(var i=0;i<this.memorySize;i++){this.memory[i]=0}this.registerFile.reset()};MIPSCore.prototype.fetch=function(){if(this.pc<0){return"Fetch Error: Negative program counter."}var arr=this.memcpy(this.pc,4);if(arr==null){return"Fetch Error: Illegal memory access."}this.pc+=4;this.fetched=catBytes(arr);return null};return MIPSCore}(Core);var debug=false;var tests=false;function assemble(core,data){var token=core.instructionSet.tokenize(data);if(debug){console.log(token.labels);console.log(token.addresses)}if(token.errorMessage===null){return core.instructionSet.assemble(null,0,token.lines,token.labels,token.addresses)}else{return{errorMessage:token.errorMessage,machineCode:null,size:0}}}function loadIntoMemory(core,data){if(core.memset(0,data)===null)return"Program is too large.";return null}function loadMemStep(core,data){var load=loadIntoMemory(core,data);if(load!==null){return load}simulateStep(core)}function simulateStep(core){var fetch=core.fetch();if(fetch!==null){return fetch}var decode=core.decode();if(decode===null){return"Address 0x"+(core.pc-4).toString(16).toUpperCase()+": Instruction unrecognized or unsupported."}core.instructionCallback(decode);if(debug){console.log(core.pc-4,decode,core.arguments)}var execute=core.execute();if(execute!==null){return execute}if(debug){}if(decode=="ECALL"||decode=="SYSCALL"){return"@Oak_Ecall"}return null}function simulate(core,data){var load=loadIntoMemory(core,data);if(load!==null){return load}return continueSim(core)}function continueSim(core){var step=simulateStep(core);var i=0;for(var i=0;i<16384&&step===null;i++){step=simulateStep(core)}if(i==16384){return"ERROR: Possible Infinite Loop"}if(step!==null){return step}return null}function registerRead(core,index){return core.registerFile.read(index)}function registerWrite(core,index,value){core.registerFile.write(index,value)}function getMemory(core){return core.memory}function getRegisterABINames(core){return core.registerFile.abiNames}function resetCore(core){core.reset()}var ecalloutput="";function Oak_terminal_eCall(){var core=this;var type=registerRead(core,17);var arg=registerRead(core,10);var exit=false;switch(type){case 1:ecalloutput+=arg+"\n";break;case 4:var pointer=arg;var output="";var char=core.memory[pointer];while(char!=0){output+=String.fromCharCode(char);pointer+=1;char=core.memory[pointer]}ecalloutput+=output+"\n";break;case 5:registerWrite(core,17,4);break;case 10:exit=true;break;default:console.log("Unsupported environment call.");break}if(!exit){var output=continueSim(core);if(output!="@Oak_Ecall"&&output!==null&&output!=undefined){console.log("ERROR: "+output)}}else{console.log("Simulation Complete.")}}if(typeof process==="object"&&process+""==="[object process]"){console.log("Oak.js  2.0-dev");console.log("All rights reserved.");console.log("You should have obtained a copy of the Mozilla Public License with your app.");console.log("If you did not, a verbatim copy should be available at https://www.mozilla.org/en-US/MPL/2.0/.");var fs=require("fs");var asm=new Assembler(RISCV,Endianness.big);console.log(asm.process("fuck",0,1,Parameter.immediate,8,{fuck:420}));process.exit(0)}else{console.log("Running from browser, suppressing terminal interface...")}if(tests){console.log("Oak.js Console Tests");var testCore=new RISCVCore(2048,Oak_terminal_eCall,function(data){});var oakHex=assemble(testCore,"main:\naddi a0, zero, 8\naddi a1, zero, 2\njal ra, mydiv\n\nli a7, 10  # calls exit command (code 10)\nSCALL # end of program\n\n## Divides two numbers, storing integer result on t0 and rest on t1\n# a0 Number we will divide\n# a1 Number we will divide for\nmydiv:\nadd t1, zero, zero # i = 0\n\nmydiv_test:\nslt t0, a0, a1 # if ( a < b )\nbne t0, zero, mydiv_end # then get out of here\nsub a0, a0, a1 # else, a = a - b\naddi t1, t1, 1 # and i = i + 1\njal x0, mydiv_test # let's test again\n\nmydiv_end:\nadd a1, zero, a0 # rest = a\nadd a0, zero, t1 # result = i\njalr x0, ra, 0").machineCode;var gnuHex="13 05 80 00 93 05 20 00 EF 00 C0 00 93 08 A0 00 73 00 00 00 33 03 00 00 B3 22 B5 00 63 98 02 00 33 05 B5 40 13 03 13 00 6F F0 1F FF B3 05 A0 00 33 05 60 00 67 80 00 00".interpretedBytes;for(var i=0;i<oakHex.length;i++){if(oakHex[i]!==gnuHex[i]){console.log("Binaries do not match.");break}}var sim=simulate(testCore,oakHex);ecalloutput="";console.log(ecalloutput);ecalloutput=""}
